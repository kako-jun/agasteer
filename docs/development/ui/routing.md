# URLルーティングとワールド

## 概要

Agasteerはブラウザの URL クエリパラメータを使用して、左右のペインの状態を永続化します。これにより、リンクの共有やブックマークが可能です。

また、「ワールド」という概念でホーム（通常のノート）とアーカイブ（退避したノート）を分離しています。

---

## URLの仕様

### パス形式

```
https://agasteer.llll-ll.com/?left=ノート名>リーフ名&right=ノート名>サブノート名>リーフ名
```

| パラメータ | 説明           |
| ---------- | -------------- |
| `left`     | 左ペインのパス |
| `right`    | 右ペインのパス |

### パスの構文

パスは `>` 区切りで階層を表現します。

| パス形式                         | 表示内容                 |
| -------------------------------- | ------------------------ |
| （空）または `/`                 | ホーム画面               |
| `ノート名`                       | ルートノート             |
| `ノート名>サブノート名`          | サブノート               |
| `ノート名>リーフ名`              | ルートノート配下のリーフ |
| `ノート名>サブノート名>リーフ名` | サブノート配下のリーフ   |

### プレビューモード

リーフをプレビュー表示で開く場合は `:preview` サフィックスを付加します。

```
?left=仕事>議事録:preview&right=/
```

### パス解決の流れ

1. URLからパスを取得（`window.location.search`）
2. `>` で分割してセグメントを取得
3. 最初のセグメントでルートノートを検索
4. 次のセグメントでサブノートまたはリーフを検索
5. 見つからない場合は上位階層にフォールバック

**実装**: `src/lib/navigation/routing.ts`

---

## ワールドの仕様

### ワールドとは

| ワールド  | 説明                                 |
| --------- | ------------------------------------ |
| `home`    | 通常のノート・リーフを管理する領域   |
| `archive` | 使わなくなったノート・リーフの退避先 |

### データ構造

ホームとアーカイブは別々のストアで管理されます。

| ストア          | 説明               |
| --------------- | ------------------ |
| `notes`         | ホームのノート     |
| `leaves`        | ホームのリーフ     |
| `archiveNotes`  | アーカイブのノート |
| `archiveLeaves` | アーカイブのリーフ |

### ワールド切り替え

`currentWorld` ストアでアクティブなワールドを管理します。切り替え時は:

1. アーカイブ初回アクセス時にGitHubからPull
2. `currentWorld` を更新
3. ホーム画面に遷移

**実装**: `src/App.svelte` の `handleWorldChange()`

---

## ワールド対応（実装済み）

### URL仕様: パス埋め込み形式

パスの先頭にワールドプレフィックスを付けることで、ペインごとに独立したワールドを指定可能。

#### URL形式

```
?left=archive:古いノート>メモ&right=仕事>議事録
```

| パス形式                | ワールド                   |
| ----------------------- | -------------------------- |
| `ノート>リーフ`         | ホーム（省略時デフォルト） |
| `home:ノート>リーフ`    | ホーム（明示的）           |
| `archive:ノート>リーフ` | アーカイブ                 |

#### URL例

```
# 両方ホーム（現状と同じ、後方互換性維持）
?left=仕事>議事録&right=/

# 左:アーカイブ、右:ホーム
?left=archive:古いノート>メモ&right=仕事>議事録

# 両方アーカイブ
?left=archive:古いノート&right=archive:別のノート>リーフ

# プレビューモードとの組み合わせ
?left=archive:古いノート>メモ:preview&right=/
```

#### メリット

- 別パラメータ（`world`）不要でシンプル
- ペインごとに独立してワールド指定可能
- 後方互換性維持（省略時はホーム）
- アーカイブへの静的URLとペイン独立を同時に実現

#### エッジケースの挙動

| ケース                                          | 挙動                                                   |
| ----------------------------------------------- | ------------------------------------------------------ |
| アーカイブ未ロード時に `archive:` URLにアクセス | 自動でアーカイブをPullしてから表示                     |
| 存在しないパスへのアクセス                      | 指定されたワールドのホーム画面を表示（ワールドは維持） |
| 1ペイン表示時に左右で異なるワールド             | 左ペインのみ表示、右ペインの状態は保持                 |

### 実装タスク

#### URL処理

- [x] `resolvePath()` でワールドプレフィックスをパース
- [x] `buildPath()` でワールドプレフィックスを出力
- [x] `updateUrlFromState()` を更新
- [x] `restoreStateFromUrl()` を更新

#### ストア・状態管理

- [x] `currentWorld` を `leftWorld` / `rightWorld` に分離
- [x] ナビゲーション関数にワールドパラメータ追加
- [x] パンくずリストのワールド表示をペインごとに分離

#### データ参照

- [x] 各ペインがワールドに応じて `notes/leaves` または `archiveNotes/archiveLeaves` を参照
- [x] パンくずリスト生成時にワールドに応じたデータを渡す（既存バグ修正）
- [x] アーカイブ初回アクセス時のPull処理との連携

#### 操作

- [x] アーカイブ/リストア操作を各ペインのワールドに対応
- [x] ワールド切り替え（パンくずリスト）を各ペインに対応

---

## 関連ドキュメント

- [リンク機能](./links.md) - タイトルリンク、外部リンク
- [レイアウト](./layout.md) - 2ペイン表示
- [GitHub同期](../sync/) - Push/Pull、アーカイブ同期
